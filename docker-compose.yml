version: '3'
services:
  zookeeper:
    image: wurstmeister/zookeeper:latest
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks:
      - shared
  kafka:
    image: wurstmeister/kafka:latest
    links:
      - "zookeeper"
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_NUM_PARTITIONS: 3
    networks:
      - shared
  proxynginx:
    build: ./nginx
    container_name: proxynginx
    links:
      - internalproxy:internalproxy
      - externalproxy:externalproxy
    networks:
      - shared
    ports:
      - "3000:3000"
      - "3001:3001"
  internalproxy:
    build:
      context: .
      dockerfile: Dockerfile.cluster
    container_name: internalproxy
    environment:
      KAFKA.KAFKA_HOSTS: "kafka:9092"
      PLUGIN_MANAGER.AUTH_SERVICE_ENDPOINT: "http://192.168.160.107:8090/dh/rest"
      PLUGIN_MANAGER.PLUGIN_MANAGEMENT_SERVICE_ENDPOINT: "http://192.168.160.107:8110/dh/rest"
      PROXY.WEB_SOCKET_SERVER_HOST: "internalproxy"
      PROXY.ENABLE_PLUGIN_MANAGER: "false"
      DEBUG: "kafka,pluginmanager"
    networks:
      - shared
  externalproxy:
    build:
      context: .
      dockerfile: Dockerfile.cluster
    container_name: externalproxy
    environment:
      KAFKA.KAFKA_HOSTS: "kafka:9092"
      PLUGIN_MANAGER.AUTH_SERVICE_ENDPOINT: "http://192.168.160.107:8090/dh/rest"
      PLUGIN_MANAGER.PLUGIN_MANAGEMENT_SERVICE_ENDPOINT: "http://192.168.160.107:8110/dh/rest"
      PROXY.WEB_SOCKET_SERVER_HOST: "externalproxy"
      PROXY.ENABLE_PLUGIN_MANAGER: "true"
      DEBUG: "kafka,pluginmanager"
    networks:
      - shared
networks:
  shared:
    driver: bridge